<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SpeechBot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Improved modal styles */
.modal {
    backdrop-filter: blur(2px);
}

.modal-content {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
    border-bottom: 1px solid #e9ecef;
    padding: 1.5rem;
}

.modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 1rem 1.5rem;
}

.modal-body {
    padding: 1.5rem;
}

.btn-close:focus {
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
    outline: none;
}

/* Ensure proper focus management */
.modal.fade .modal-dialog {
    transform: translate(0, -50px);
    transition: transform 0.3s ease-out;
}

.modal.show .modal-dialog {
    transform: none;
}

/* Improve accessibility for modal backdrops */
.modal-backdrop {
    opacity: 0.5;
}
        .admin-container {
            max-width: 1400px;
            margin: 100px auto 30px auto;
            padding: 0 15px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        .admin-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .nav-tabs .nav-link.active {
            color: #667eea;
            font-weight: 600;
        }
        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .website-link {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .badge {
            font-size: 0.75em;
        }
        .search-box {
            max-width: 400px;
            margin-bottom: 20px;
        }
        .client-details-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .question-item {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .pagination {
            margin-top: 20px;
        }
        .question-management {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>SpeechBot- Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="admin.html"><i class="fas fa-home me-1"></i> Dashboard</a>
                <a class="nav-link" href="#" onclick="authService.logout()"><i class="fas fa-sign-out-alt me-1"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Welcome Section -->
        <div class="admin-section">
            <h1><i class="fas fa-shield-alt me-2"></i>Admin Dashboard</h1>
            <p class="text-muted">System administration and management</p>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <p class="stat-number" id="totalClients">0</p>
                <p class="stat-label">Total Clients</p>
            </div>
            <div class="stat-card">
                <p class="stat-number" id="totalEmployees">0</p>
                <p class="stat-label">Total Employees</p>
            </div>
            <div class="stat-card">
                <p class="stat-number" id="totalQuestions">0</p>
                <p class="stat-label">Total Questions</p>
            </div>
            <div class="stat-card">
                <p class="stat-number" id="totalSubscriptions">0</p>
                <p class="stat-label">Active Subscriptions</p>
            </div>
        </div>

        <!-- Management Tabs -->
        <div class="admin-section">
            <ul class="nav nav-tabs mb-4" id="adminTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#clients">
                        <i class="fas fa-users me-2"></i>Clients
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#employees">
                        <i class="fas fa-user-tie me-2"></i>Employees
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#notifications">
                        <i class="fas fa-bell me-2"></i>Notifications
                        <span class="badge bg-danger ms-1" id="notificationBadge">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#questions">
                        <i class="fas fa-question-circle me-2"></i>Questions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#subscriptions">
                        <i class="fas fa-crown me-2"></i>Subscriptions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#logs">
                        <i class="fas fa-history me-2"></i>System Logs
                    </a>
                </li>
            </ul>
            
            <div class="tab-content">
                <!-- Clients Tab -->
                <div class="tab-pane fade show active" id="clients">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>All Clients</h4>
                        <div class="search-box">
                            <input type="text" id="clientSearch" class="form-control" placeholder="Search clients by name, email, or website...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Website</th>
                                    <th>Plan</th>
                                    <th>Status</th>
                                    <th>Questions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsList">
                                <tr>
                                    <td colspan="7" class="text-center">Loading clients...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Employees Tab -->
                <div class="tab-pane fade" id="employees">
                    <h4>All Employees</h4>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Client</th>
                                    <th>Website</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeesList">
                                <tr>
                                    <td colspan="6" class="text-center">Loading employees...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Notifications Tab -->
                <div class="tab-pane fade" id="notifications">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-bell me-2"></i>Notifications</h4>
                        <button class="btn btn-sm btn-outline-secondary" onclick="markAllNotificationsAsRead()">
                            <i class="fas fa-check-double me-2"></i>Mark All as Read
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Title</th>
                                    <th>Message</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="notificationsList">
                                <tr>
                                    <td colspan="7" class="text-center">Loading notifications...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Questions Tab -->
                <div class="tab-pane fade" id="questions">
                    <h4>All Questions</h4>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Answer</th>
                                    <th>Client</th>
                                    <th>Website</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody id="questionsList">
                                <tr>
                                    <td colspan="5" class="text-center">Loading questions...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Subscriptions Tab -->
                <div class="tab-pane fade" id="subscriptions">
                    <h4>All Subscriptions</h4>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Plan</th>
                                    <th>Amount</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Status</th>
                                    <th>Payment ID</th>
                                </tr>
                            </thead>
                            <tbody id="subscriptionsList">
                                <tr>
                                    <td colspan="7" class="text-center">Loading subscriptions...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Logs Tab -->
                <div class="tab-pane fade" id="logs">
                    <h4>System Logs</h4>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>User</th>
                                    <th>User Type</th>
                                    <th>Website</th>
                                    <th>Details</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="logsList">
                                <tr>
                                    <td colspan="6" class="text-center">Loading logs...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <!-- Client Details Modal -->
<div class="modal fade" id="clientDetailsModal" tabindex="-1" aria-labelledby="clientDetailsModalLabel" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientDetailsModalLabel">Client Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="clientDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Add Question Modal -->
    <div class="modal fade" id="addQuestionModal" tabindex="-1" aria-labelledby="addQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addQuestionModalLabel">
                        <i class="fas fa-plus me-2"></i>Add Question for Client
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addQuestionForm">
                        <input type="hidden" id="addQuestionClientId">
                        <div class="mb-3">
                            <label for="newQuestion" class="form-label">Question</label>
                            <input type="text" class="form-control" id="newQuestion" required>
                        </div>
                        <div class="mb-3">
                            <label for="newAnswer" class="form-label">Answer</label>
                            <textarea class="form-control" id="newAnswer" rows="4" required></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This will count against the client's question limit: 
                            <span id="questionLimitInfo">0/0</span> questions used.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addQuestionForClient()">
                        <i class="fas fa-save me-2"></i>Add Question
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Question Modal -->
    <div class="modal fade" id="editQuestionModal" tabindex="-1" aria-labelledby="editQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editQuestionModalLabel">
                        <i class="fas fa-edit me-2"></i>Edit Question
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editQuestionForm">
                        <input type="hidden" id="editQuestionId">
                        <input type="hidden" id="editQuestionClientId">
                        <div class="mb-3">
                            <label for="editQuestion" class="form-label">Question</label>
                            <input type="text" class="form-control" id="editQuestion" required>
                        </div>
                        <div class="mb-3">
                            <label for="editAnswer" class="form-label">Answer</label>
                            <textarea class="form-control" id="editAnswer" rows="4" required></textarea>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            This will count against the client's modification limit: 
                            <span id="modificationLimitInfo">0/0</span> modifications used.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateQuestionForClient()">
                        <i class="fas fa-save me-2"></i>Update Question
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Question Confirmation Modal -->
    <div class="modal fade" id="deleteQuestionModal" tabindex="-1" aria-labelledby="deleteQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteQuestionModalLabel">
                        <i class="fas fa-trash me-2"></i>Delete Question
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this question?</p>
                    <div class="question-preview bg-light p-3 rounded">
                        <strong id="deleteQuestionPreview"></strong>
                    </div>
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This action will use one of the client's modification credits.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteButton" onclick="confirmDeleteQuestion()">
                        <i class="fas fa-trash me-2"></i>Delete Question
                    </button>
                </div>
            </div>
        </div>
    </div>

 <!-- Notification Details Modal -->
<div class="modal fade" id="notificationDetailsModal" tabindex="-1" aria-labelledby="notificationDetailsModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationDetailsModalLabel">
                    <i class="fas fa-bell me-2"></i>Notification Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="notificationDetailsContent">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="processRequestBtn" style="display: none;">
                    <i class="fas fa-cog me-2"></i>Process Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Process Request Modal -->
<!-- Process Question Request Modal -->
<div class="modal fade" id="processRequestModal" tabindex="-1" aria-labelledby="processRequestModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processRequestModalLabel">
                    <i class="fas fa-cog me-2"></i>Process Question Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="processRequestForm">
                    <input type="hidden" id="processRequestId">
                    <div class="mb-3">
                        <label for="requestStatus" class="form-label">Status *</label>
                        <select class="form-control" id="requestStatus" required>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="adminNotes" class="form-label">Admin Notes</label>
                        <textarea class="form-control" id="adminNotes" rows="3" 
                                 placeholder="Add any notes or instructions..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateQuestionRequest()">
                    <i class="fas fa-save me-2"></i>Update Request
                </button>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../scripts/auth.js"></script>
    <script>
        // SINGLE DECLARATION - Remove any duplicate declarations elsewhere
        let clientNameMap = {};
        let clientWebsiteMap = {};
        let currentClientPage = 1;
        let currentClientDetailsId = null;
        let currentDeleteQuestionId = null;
        let currentDeleteQuestionClientId = null;
        const clientsPerPage = 10;

        // Notification functionality
        let currentNotifications = [];
        let unreadCount = 0;

        // Load admin data when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is admin
            if (authService.getUserType() !== 'admin') {
                alert('Access denied. Admin privileges required.');
                window.location.href = 'dashboard.html';
                return;
            }
            
            await loadAdminData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Client search functionality
            document.getElementById('clientSearch').addEventListener('input', function(e) {
                const query = e.target.value;
                searchClients(query);
            });
        }

        async function searchClients(query) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/clients-search?query=${encodeURIComponent(query)}`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const clients = await response.json();
                    displayClients(clients);
                }
            } catch (error) {
                console.error('Error searching clients:', error);
            }
        }

        async function loadClientWebsiteMap() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/clients`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const clients = await response.json();
                    clientWebsiteMap = {};
                    clients.forEach(client => {
                        clientWebsiteMap[client._id] = {
                            website: client.website,
                            name: client.name
                        };
                    });
                }
            } catch (error) {
                console.error('Error loading client websites:', error);
            }
        }

        async function loadClientNameMap() {
            try {
                // Load clients
                const clientsResponse = await fetch(`${API_BASE_URL}/admin/clients`, {
                    headers: authService.getAuthHeaders()
                });
                
                // Load employees
                const employeesResponse = await fetch(`${API_BASE_URL}/admin/employees`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (clientsResponse.ok && employeesResponse.ok) {
                    const clients = await clientsResponse.json();
                    const employees = await employeesResponse.json();
                    
                    clientNameMap = {};
                    
                    // Map clients
                    clients.forEach(client => {
                        clientNameMap[client._id] = client.name;
                        clientNameMap[client.email] = client.name;
                    });
                    
                    // Map employees
                    employees.forEach(employee => {
                        clientNameMap[employee._id] = employee.name;
                        clientNameMap[employee.email] = employee.name;
                    });
                }
            } catch (error) {
                console.error('Error loading client names:', error);
            }
        }

        async function loadAdminData() {
            await loadClientWebsiteMap();
            await loadClientNameMap();
            await loadClients();
            await loadEmployees();
            await loadQuestions();
            await loadSubscriptions();
            await loadLogs();
            await loadStats();
            await loadNotifications();
            startNotificationPolling();
        }

        async function loadClients() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/clients`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const clients = await response.json();
                    displayClients(clients);
                }
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        function displayClients(clients) {
            const clientsList = document.getElementById('clientsList');
            
            if (clients.length === 0) {
                clientsList.innerHTML = '<tr><td colspan="7" class="text-center">No clients found</td></tr>';
                return;
            }

            clientsList.innerHTML = clients.map(client => `
                <tr>
                    <td>
                        <a href="#" onclick="viewClientDetails('${client._id}')" class="text-decoration-none">
                            <strong>${client.name}</strong>
                        </a>
                    </td>
                    <td>${client.email}</td>
                    <td>
                        <a href="${client.website.startsWith('http') ? client.website : 'https://' + client.website}" 
                           target="_blank" class="text-decoration-none website-link">
                            <i class="fas fa-external-link-alt me-1"></i>
                            ${client.website}
                        </a>
                    </td>
                    <td>
                        <span class="badge ${client.subscription_plan === 'trial' ? 'bg-secondary' : 'bg-success'}">
                            ${client.subscription_plan}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${client.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${client.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <small>${client.questions_used || 0}/${client.questions_allowed || 0}</small>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="viewClientDetails('${client._id}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteClient('${client._id}')">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function viewClientDetails(clientId) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/clients/${clientId}`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const clientDetails = await response.json();
                    currentClientDetailsId = clientId;
                    displayClientDetails(clientDetails);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('clientDetailsModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading client details:', error);
                showNotification('Error loading client details', 'error');
            }
        }

        function displayClientDetails(details) {
            const content = document.getElementById('clientDetailsContent');
            const client = details.client_info;
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="client-details-section">
                            <h6><i class="fas fa-user me-2"></i>Client Information</h6>
                            <table class="table table-sm table-borderless">
                                <tr><th>Name:</th><td>${escapeHtml(client.name)}</td></tr>
                                <tr><th>Email:</th><td>${escapeHtml(client.email)}</td></tr>
                                <tr><th>Mobile:</th><td>${escapeHtml(client.mobile || 'N/A')}</td></tr>
                                <tr><th>Website:</th><td>${escapeHtml(client.website)}</td></tr>
                                <tr><th>Business Type:</th><td>${escapeHtml(client.business_type || 'N/A')}</td></tr>
                                <tr><th>Location:</th><td>${escapeHtml(client.location || 'N/A')}</td></tr>
                                <tr><th>PAN:</th><td>${escapeHtml(client.pan || 'N/A')}</td></tr>
                                <tr><th>TAN:</th><td>${escapeHtml(client.tan || 'N/A')}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="client-details-section">
                            <h6><i class="fas fa-crown me-2"></i>Subscription Details</h6>
                            <table class="table table-sm table-borderless">
                                <tr><th>Plan:</th><td><span class="badge ${client.subscription_plan === 'trial' ? 'bg-secondary' : 'bg-success'}">${client.subscription_plan}</span></td></tr>
                                <tr><th>Status:</th><td><span class="badge ${client.is_active ? 'bg-success' : 'bg-danger'}">${client.is_active ? 'Active' : 'Inactive'}</span></td></tr>
                                <tr><th>Start Date:</th><td>${new Date(client.subscription_start).toLocaleDateString()}</td></tr>
                                <tr><th>End Date:</th><td>${new Date(client.subscription_end).toLocaleDateString()}</td></tr>
                                <tr><th>Questions Used:</th><td>${client.questions_used}/${client.questions_allowed}</td></tr>
                                <tr><th>Modifications Used:</th><td>${client.modifications_used || 0}/${client.modifications_allowed || 0}</td></tr>
                                <tr><th>Account Created:</th><td>${new Date(client.created_at).toLocaleDateString()}</td></tr>
                            </table>
                            <button class="btn btn-primary btn-sm mt-2" onclick="openAddQuestionModal('${client._id}')">
                                <i class="fas fa-plus me-1"></i>Add Question
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Questions Section with Management -->
                <div class="client-details-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="fas fa-question-circle me-2"></i>Questions (${details.questions.total})</h6>
                        <button class="btn btn-primary btn-sm" onclick="openAddQuestionModal('${client._id}')">
                            <i class="fas fa-plus me-1"></i>Add Question
                        </button>
                    </div>
                    ${details.questions.data.length > 0 ? `
                        <div class="row">
                            ${details.questions.data.map(q => `
                                <div class="col-md-6 mb-3">
                                    <div class="question-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <strong class="d-block flex-grow-1">${escapeHtml(q.question)}</strong>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-warning" onclick="openEditQuestionModal('${q._id}', '${client._id}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="openDeleteQuestionModal('${q._id}', '${client._id}', '${escapeHtml(q.question)}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-2">${escapeHtml(q.answer)}</small>
                                        <div class="mt-1">
                                            <small class="text-muted">Created: ${new Date(q.created_at).toLocaleDateString()}</small>
                                            ${q.updated_at ? `<small class="text-muted ms-2">Updated: ${new Date(q.updated_at).toLocaleDateString()}</small>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${details.questions.total > 10 ? `
                            <div class="text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="loadMoreQuestions('${client._id}')">
                                    Load More Questions (${details.questions.total - 10} remaining)
                                </button>
                            </div>
                        ` : ''}
                    ` : '<p class="text-muted">No questions found. Add questions using the button above.</p>'}
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="client-details-section">
                            <h6><i class="fas fa-user-tie me-2"></i>Employees (${details.employees.length})</h6>
                            ${details.employees.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Mobile</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${details.employees.map(emp => `
                                                <tr>
                                                    <td>${escapeHtml(emp.name)}</td>
                                                    <td>${escapeHtml(emp.email)}</td>
                                                    <td>${escapeHtml(emp.mobile || 'N/A')}</td>
                                                    <td><span class="badge ${emp.is_active ? 'bg-success' : 'bg-secondary'}">${emp.is_active ? 'Active' : 'Inactive'}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-muted">No employees found</p>'}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="client-details-section">
                            <h6><i class="fas fa-receipt me-2"></i>Subscription History (${details.subscriptions.length})</h6>
                            ${details.subscriptions.length > 0 ? `
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Plan</th>
                                                <th>Amount</th>
                                                <th>Start Date</th>
                                                <th>End Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${details.subscriptions.map(sub => `
                                                <tr>
                                                    <td><span class="badge bg-info">${sub.plan}</span></td>
                                                    <td>â‚¹${(sub.amount / 100).toFixed(2)}</td>
                                                    <td>${new Date(sub.start_date).toLocaleDateString()}</td>
                                                    <td>${new Date(sub.end_date).toLocaleDateString()}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-muted">No subscription history</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Admin Question Management Functions
        async function openAddQuestionModal(clientId) {
            document.getElementById('addQuestionClientId').value = clientId;
            
            // Load client details to show limits
            try {
                const response = await fetch(`${API_BASE_URL}/admin/clients/${clientId}`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const clientDetails = await response.json();
                    const clientInfo = clientDetails.client_info;
                    document.getElementById('questionLimitInfo').textContent = 
                        `${clientInfo.questions_used}/${clientInfo.questions_allowed}`;
                }
            } catch (error) {
                console.error('Error loading client details:', error);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addQuestionModal'));
            modal.show();
        }

        async function addQuestionForClient() {
            const clientId = document.getElementById('addQuestionClientId').value;
            const question = document.getElementById('newQuestion').value.trim();
            const answer = document.getElementById('newAnswer').value.trim();

            if (!question || !answer) {
                showNotification('Please fill both question and answer fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/questions`, {
                    method: 'POST',
                    headers: authService.getAuthHeaders(),
                    body: JSON.stringify({
                        client_id: clientId,
                        question: question,
                        answer: answer
                    })
                });

                if (response.ok) {
                    showNotification('Question added successfully!', 'success');
                    
                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addQuestionModal'));
                    modal.hide();
                    document.getElementById('addQuestionForm').reset();
                    
                    // Refresh client details if modal is open
                    if (currentClientDetailsId === clientId) {
                        await viewClientDetails(clientId);
                    }
                    
                    // Refresh questions list
                    await loadQuestions();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to add question');
                }
            } catch (error) {
                console.error('Error adding question:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function openEditQuestionModal(questionId, clientId) {
            document.getElementById('editQuestionId').value = questionId;
            document.getElementById('editQuestionClientId').value = clientId;
            
            // Load question details
            try {
                const response = await fetch(`${API_BASE_URL}/questions`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const questions = await response.json();
                    const question = questions.find(q => q._id === questionId);
                    
                    if (question) {
                        document.getElementById('editQuestion').value = question.question;
                        document.getElementById('editAnswer').value = question.answer;
                    }
                }
                
                // Load client details to show modification limits
                const clientResponse = await fetch(`${API_BASE_URL}/admin/clients/${clientId}`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (clientResponse.ok) {
                    const clientDetails = await clientResponse.json();
                    const clientInfo = clientDetails.client_info;
                    document.getElementById('modificationLimitInfo').textContent = 
                        `${clientInfo.modifications_used}/${clientInfo.modifications_allowed}`;
                }
            } catch (error) {
                console.error('Error loading question details:', error);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('editQuestionModal'));
            modal.show();
        }

        async function updateQuestionForClient() {
            const questionId = document.getElementById('editQuestionId').value;
            const question = document.getElementById('editQuestion').value.trim();
            const answer = document.getElementById('editAnswer').value.trim();

            if (!question || !answer) {
                showNotification('Please fill both question and answer fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/questions/${questionId}`, {
                    method: 'PUT',
                    headers: authService.getAuthHeaders(),
                    body: JSON.stringify({
                        question: question,
                        answer: answer
                    })
                });

                if (response.ok) {
                    showNotification('Question updated successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editQuestionModal'));
                    modal.hide();
                    
                    // Refresh client details if modal is open
                    const clientId = document.getElementById('editQuestionClientId').value;
                    if (currentClientDetailsId === clientId) {
                        await viewClientDetails(clientId);
                    }
                    
                    // Refresh questions list
                    await loadQuestions();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to update question');
                }
            } catch (error) {
                console.error('Error updating question:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function openDeleteQuestionModal(questionId, clientId, questionText) {
            currentDeleteQuestionId = questionId;
            currentDeleteQuestionClientId = clientId;
            document.getElementById('deleteQuestionPreview').textContent = questionText;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteQuestionModal'));
            modal.show();
        }

        async function confirmDeleteQuestion() {
            if (!currentDeleteQuestionId || !currentDeleteQuestionClientId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/admin/questions/${currentDeleteQuestionId}`, {
                    method: 'DELETE',
                    headers: authService.getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Question deleted successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteQuestionModal'));
                    modal.hide();
                    
                    // Refresh client details if modal is open
                    if (currentClientDetailsId === currentDeleteQuestionClientId) {
                        await viewClientDetails(currentDeleteQuestionClientId);
                    }
                    
                    // Refresh questions list
                    await loadQuestions();
                    
                    // Reset state
                    currentDeleteQuestionId = null;
                    currentDeleteQuestionClientId = null;
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to delete question');
                }
            } catch (error) {
                console.error('Error deleting question:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function loadMoreQuestions(clientId) {
            showNotification('Loading more questions...', 'info');
            // You would need to implement pagination endpoint for this
        }

        async function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client and all their data?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/clients/${clientId}`, {
                        method: 'DELETE',
                        headers: authService.getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        showNotification('Client deleted successfully', 'success');
                        await loadAdminData(); // Reload all data
                    }
                } catch (error) {
                    console.error('Error deleting client:', error);
                    showNotification('Error deleting client', 'error');
                }
            }
        }

        async function loadEmployees() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/employees`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const employees = await response.json();
                    displayEmployees(employees);
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        function displayEmployees(employees) {
            const employeesList = document.getElementById('employeesList');
            
            if (employees.length === 0) {
                employeesList.innerHTML = '<tr><td colspan="6" class="text-center">No employees found</td></tr>';
                return;
            }

            employeesList.innerHTML = employees.map(employee => `
                <tr>
                    <td>${employee.name}</td>
                    <td>${employee.email}</td>
                    <td>${clientNameMap[employee.client_id] || 'Unknown Client'}</td>
                    <td>${employee.website}</td>
                    <td>
                        <span class="badge ${employee.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${employee.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmployee('${employee._id}')">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteEmployee(employeeId) {
            if (confirm('Are you sure you want to delete this employee?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/employees/${employeeId}`, {
                        method: 'DELETE',
                        headers: authService.getAuthHeaders()
                    });
                    
                    if (response.ok) {
                        showNotification('Employee deleted successfully', 'success');
                        await loadEmployees();
                    }
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    showNotification('Error deleting employee', 'error');
                }
            }
        }

        async function loadQuestions() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/questions`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const questions = await response.json();
                    displayQuestions(questions);
                } else {
                    console.error('Failed to load questions:', response.status);
                    displayQuestions([]);
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                displayQuestions([]);
            }
        }

        function displayQuestions(questions) {
            const questionsList = document.getElementById('questionsList');
            
            if (!questionsList) {
                console.error('Questions list element not found');
                return;
            }
            
            if (questions.length === 0) {
                questionsList.innerHTML = '<tr><td colspan="5" class="text-center">No questions found</td></tr>';
                return;
            }

            questionsList.innerHTML = questions.map(question => `
                <tr>
                    <td>${question.question}</td>
                    <td>${question.answer.substring(0, 100)}${question.answer.length > 100 ? '...' : ''}</td>
                    <td>${clientNameMap[question.client_id] || 'Unknown Client'}</td>
                    <td>${question.website || 'N/A'}</td>
                    <td>${new Date(question.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');
        }

        async function loadSubscriptions() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/subscriptions`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const subscriptions = await response.json();
                    displaySubscriptions(subscriptions);
                }
            } catch (error) {
                console.error('Error loading subscriptions:', error);
            }
        }

        function displaySubscriptions(subscriptions) {
            const subscriptionsList = document.getElementById('subscriptionsList');
            
            if (subscriptions.length === 0) {
                subscriptionsList.innerHTML = '<tr><td colspan="7" class="text-center">No subscriptions found</td></tr>';
                return;
            }

            subscriptionsList.innerHTML = subscriptions.map(sub => {
                const isActive = new Date(sub.end_date) > new Date();
                return `
                    <tr>
                        <td>${clientNameMap[sub.client_id] || 'Unknown Client'}</td>
                        <td>
                            <span class="badge ${getSubscriptionBadgeClass(sub.plan)}">
                                ${sub.plan}
                            </span>
                        </td>
                        <td>â‚¹${(sub.amount / 100).toFixed(2)}</td>
                        <td>${new Date(sub.start_date).toLocaleDateString()}</td>
                        <td>${new Date(sub.end_date).toLocaleDateString()}</td>
                        <td>
                            <span class="badge ${isActive ? 'bg-success' : 'bg-danger'}">
                                ${isActive ? 'Active' : 'Expired'}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">${sub.razorpay_payment_id || 'N/A'}</small>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadLogs() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/logs?limit=50`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const logs = await response.json();
                    displayLogs(logs);
                }
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        function displayLogs(logs) {
            const logsList = document.getElementById('logsList');
            
            if (logs.length === 0) {
                logsList.innerHTML = '<tr><td colspan="6" class="text-center">No logs found</td></tr>';
                return;
            }

            logsList.innerHTML = logs.map(log => `
                <tr>
                    <td>
                        <span class="badge ${getActionBadge(log.action)}">${formatAction(log.action)}</span>
                    </td>
                    <td>
                        ${clientNameMap[log.user_id] || log.user_id}
                    </td>
                    <td>
                        <span class="badge ${getUserTypeBadge(log.user_type)}">${log.user_type}</span>
                    </td>
                    <td>
                        ${getWebsiteLink(log)}
                    </td>
                    <td>
                        <small>${formatLogDetails(log.details)}</small>
                    </td>
                    <td>
                        <small>${new Date(log.timestamp).toLocaleString()}</small>
                    </td>
                </tr>
            `).join('');
        }

        function getWebsiteLink(log) {
            if (!log.client_id) return '<span class="text-muted">N/A</span>';
            
            const clientInfo = clientWebsiteMap[log.client_id];
            if (clientInfo && clientInfo.website) {
                const website = clientInfo.website.startsWith('http') ? clientInfo.website : `https://${clientInfo.website}`;
                return `
                    <a href="${website}" target="_blank" class="text-decoration-none website-link">
                        <i class="fas fa-external-link-alt me-1"></i>
                        ${clientInfo.website}
                    </a>
                `;
            }
            return '<span class="text-muted">Unknown Website</span>';
        }

        function formatAction(action) {
            const actionMap = {
                'client_signup': 'Client Signup',
                'admin_add_question': 'Admin Add Question',
                'admin_update_question': 'Admin Update Question',
                'admin_delete_question': 'Admin Delete Question',
                'create_employee': 'Create Employee',
                'update_employee': 'Update Employee',
                'delete_employee': 'Delete Employee',
                'subscription_created': 'Subscription Created',
                'create_question_request': 'Create Question Request',
                'update_question_request': 'Update Question Request'
            };
            return actionMap[action] || action.replace('_', ' ');
        }

        function getActionBadge(action) {
            const badgeMap = {
                'client_signup': 'bg-success',
                'admin_add_question': 'bg-primary',
                'admin_update_question': 'bg-warning',
                'admin_delete_question': 'bg-danger',
                'create_employee': 'bg-info',
                'update_employee': 'bg-warning',
                'delete_employee': 'bg-danger',
                'subscription_created': 'bg-success',
                'create_question_request': 'bg-info',
                'update_question_request': 'bg-warning'
            };
            return badgeMap[action] || 'bg-secondary';
        }

        function formatLogDetails(details) {
            if (!details) return 'N/A';
            
            try {
                if (typeof details === 'string') {
                    return details;
                }
                return Object.entries(details)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join(', ');
            } catch (error) {
                return JSON.stringify(details);
            }
        }

        function getUserTypeBadge(userType) {
            const badgeMap = {
                'admin': 'bg-danger',
                'client': 'bg-success', 
                'employee': 'bg-warning'
            };
            return badgeMap[userType] || 'bg-secondary';
        }

        function getSubscriptionBadgeClass(plan) {
            const classes = {
                'trial': 'bg-warning',
                'monthly': 'bg-info',
                'quarterly': 'bg-success',
                'yearly': 'bg-success'
            };
            return classes[plan] || 'bg-info';
        }

        async function loadStats() {
            const clientsResponse = await fetch(`${API_BASE_URL}/admin/clients`, {
                headers: authService.getAuthHeaders()
            });
            const employeesResponse = await fetch(`${API_BASE_URL}/admin/employees`, {
                headers: authService.getAuthHeaders()
            });
            const questionsResponse = await fetch(`${API_BASE_URL}/admin/questions`, {
                headers: authService.getAuthHeaders()
            });
            const subscriptionsResponse = await fetch(`${API_BASE_URL}/admin/subscriptions`, {
                headers: authService.getAuthHeaders()
            });
            
            if (clientsResponse.ok && employeesResponse.ok && questionsResponse.ok && subscriptionsResponse.ok) {
                const clients = await clientsResponse.json();
                const employees = await employeesResponse.json();
                const questions = await questionsResponse.json();
                const subscriptions = await subscriptionsResponse.json();
                
                document.getElementById('totalClients').textContent = clients.length;
                document.getElementById('totalEmployees').textContent = employees.length;
                document.getElementById('totalQuestions').textContent = questions.length;
                document.getElementById('totalSubscriptions').textContent = 
                    subscriptions.filter(sub => new Date(sub.end_date) > new Date()).length;
            }
        }

        // Notification functionality
        async function loadNotifications() {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    currentNotifications = await response.json();
                    displayNotifications(currentNotifications);
                    await updateUnreadCount();
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

       function displayNotifications(notifications) {
    const notificationsList = document.getElementById('notificationsList');
    
    if (!notificationsList) {
        console.error('Notifications list element not found');
        return;
    }
    
    if (notifications.length === 0) {
        notificationsList.innerHTML = `
            <tr>
                <td colspan="7" class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h4>No Notifications</h4>
                        <p>You're all caught up!</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    notificationsList.innerHTML = notifications.map(notification => `
        <tr class="${notification.is_read ? '' : 'table-warning'}">
            <td>
                <span class="badge ${getNotificationTypeBadge(notification.type)}">
                    ${notification.type.replace(/_/g, ' ').toUpperCase()}
                </span>
            </td>
            <td>
                <strong>${notification.title}</strong>
            </td>
            <td>${notification.message}</td>
            <td>${getClientNameFromNotification(notification)}</td>
            <td>
                <small>${new Date(notification.created_at).toLocaleString()}</small>
            </td>
            <td>
                <span class="badge ${notification.is_read ? 'bg-secondary' : 'bg-success'}">
                    ${notification.is_read ? 'Read' : 'Unread'}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="viewNotificationDetails('${notification._id}')">
                    <i class="fas fa-eye me-1"></i>View
                </button>
                ${!notification.is_read ? `
                    <button class="btn btn-sm btn-success" onclick="markNotificationAsRead('${notification._id}')">
                        <i class="fas fa-check me-1"></i>Mark Read
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}
        function getNotificationTypeBadge(type) {
            const badges = {
                'question_request': 'bg-primary',
                'question_request_update': 'bg-info',
                'system': 'bg-secondary'
            };
            return badges[type] || 'bg-secondary';
        }

        function getClientNameFromNotification(notification) {
            if (notification.data && notification.data.client_name) {
                return notification.data.client_name;
            }
            return 'Unknown Client';
        }

   async function viewNotificationDetails(notificationId) {
    try {
        const notification = currentNotifications.find(n => n._id === notificationId);
        if (!notification) return;

        // Only mark as read if it's not already read
        if (!notification.is_read) {
            await markNotificationAsRead(notificationId);
        }

        const content = document.getElementById('notificationDetailsContent');
        const processBtn = document.getElementById('processRequestBtn');

        if (notification.type === 'question_request') {
            content.innerHTML = `
                <div class="notification-details">
                    <h6><i class="fas fa-question-circle me-2"></i>Question Request Details</h6>
                    <table class="table table-sm table-borderless">
                        <tr><th>Client:</th><td>${notification.data.client_name || 'Unknown'}</td></tr>
                        <tr><th>Request Type:</th><td><span class="badge bg-primary">${notification.data.request_type.toUpperCase()}</span></td></tr>
                        <tr><th>Question Number:</th><td>${notification.data.question_number ? `Q${notification.data.question_number}` : 'N/A'}</td></tr>
                        <tr><th>Question:</th><td class="fw-bold">${notification.data.question || 'N/A'}</td></tr>
                        <tr><th>Answer:</th><td>${notification.data.answer || 'N/A'}</td></tr>
                        <tr><th>Submitted By:</th><td>${notification.data.created_by_type || 'Client'}</td></tr>
                        <tr><th>Date:</th><td>${new Date(notification.created_at).toLocaleString()}</td></tr>
                        <tr><th>Notification Status:</th><td><span class="badge ${notification.is_read ? 'bg-success' : 'bg-warning'}">${notification.is_read ? 'Read' : 'Unread'}</span></td></tr>
                    </table>
                </div>
            `;
            
            // Show and configure the process button
            processBtn.style.display = 'block';
            processBtn.onclick = () => {
                // Close the notification modal first
                const notificationModal = bootstrap.Modal.getInstance(document.getElementById('notificationDetailsModal'));
                if (notificationModal) {
                    notificationModal.hide();
                }
                
                // Small delay to ensure modal is closed
                setTimeout(() => {
                    document.getElementById('processRequestId').value = notification.data.request_id;
                    
                    // Update modal title with request details
                    document.getElementById('processRequestModalLabel').innerHTML = `
                        <i class="fas fa-cog me-2"></i>Process Request - ${notification.data.request_type.toUpperCase()}
                    `;
                    
                    // Pre-fill placeholder with context
                    if (notification.data.question_number) {
                        document.getElementById('adminNotes').placeholder = 
                            `Processing modification for Q${notification.data.question_number}: ${notification.data.question}`;
                    }
                    
                    const processModal = new bootstrap.Modal(document.getElementById('processRequestModal'));
                    processModal.show();
                }, 300);
            };
            
        } else {
            content.innerHTML = `
                <div class="notification-details">
                    <h6>${notification.title}</h6>
                    <p>${notification.message}</p>
                    <p><strong>Date:</strong> ${new Date(notification.created_at).toLocaleString()}</p>
                    <p><strong>Status:</strong> <span class="badge ${notification.is_read ? 'bg-success' : 'bg-warning'}">${notification.is_read ? 'Read' : 'Unread'}</span></p>
                </div>
            `;
            processBtn.style.display = 'none';
        }

        const modal = new bootstrap.Modal(document.getElementById('notificationDetailsModal'));
        modal.show();

    } catch (error) {
        console.error('Error viewing notification details:', error);
        showNotification('Error loading notification details', 'error');
    }
}// Simple approach - close first modal completely before opening second
function openProcessRequestModalSimple(requestId) {
    // Close the notification modal first
    const notificationModal = bootstrap.Modal.getInstance(document.getElementById('notificationDetailsModal'));
    if (notificationModal) {
        notificationModal.hide();
        
        // Wait for the modal to be completely hidden
        document.getElementById('notificationDetailsModal').addEventListener('hidden.bs.modal', function handler() {
            document.getElementById('notificationDetailsModal').removeEventListener('hidden.bs.modal', handler);
            
            // Now set up and show the process modal
            document.getElementById('processRequestId').value = requestId;
            
            const notification = currentNotifications.find(n => 
                n.type === 'question_request' && n.data.request_id === requestId
            );
            
            if (notification) {
                document.getElementById('processRequestModalLabel').innerHTML = `
                    <i class="fas fa-cog me-2"></i>Process Request - ${notification.data.request_type.toUpperCase()}
                `;
            }
            
            const processModal = new bootstrap.Modal(document.getElementById('processRequestModal'));
            processModal.show();
        });
    }
}

// Update the process button in viewNotificationDetails

async function updateQuestionRequest() {
    try {
        const requestId = document.getElementById('processRequestId').value;
        const status = document.getElementById('requestStatus').value;
        const adminNotes = document.getElementById('adminNotes').value;

        if (!requestId) {
            showNotification('No request ID found', 'error');
            return;
        }

        console.log(`Updating question request: ${requestId}, Status: ${status}`);

        const response = await fetch(`${API_BASE_URL}/question-requests/${requestId}`, {
            method: 'PUT',
            headers: authService.getAuthHeaders(),
            body: JSON.stringify({
                status: status,
                admin_notes: adminNotes
            })
        });

        if (response.ok) {
            showNotification('Question request updated successfully!', 'success');
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('processRequestModal'));
            if (modal) {
                modal.hide();
            }
            
            // Reset the form
            document.getElementById('processRequestForm').reset();
            document.getElementById('processRequestId').value = '';
            
            // Reload notifications to reflect changes
            await loadNotifications();
        } else {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to update request');
        }
    } catch (error) {
        console.error('Error updating question request:', error);
        showNotification('Error updating request: ' + error.message, 'error');
    }
}      
document.addEventListener('DOMContentLoaded', function() {
    // Setup modal event listeners
    const processModal = document.getElementById('processRequestModal');
    if (processModal) {
        processModal.addEventListener('hidden.bs.modal', function() {
            // Reset form when modal is closed
            document.getElementById('processRequestForm').reset();
        });
    }
    
    const notificationModal = document.getElementById('notificationDetailsModal');
    if (notificationModal) {
        notificationModal.addEventListener('hidden.bs.modal', function() {
            // Clean up any temporary state
            document.getElementById('processRequestBtn').style.display = 'none';
        });
    }
});

async function markNotificationAsRead(notificationId) {
    try {
        console.log(`ðŸ“¨ Marking notification as read: ${notificationId}`);
        
        const response = await fetch(`${API_BASE_URL}/notifications/${notificationId}/read`, {
            method: 'PUT',
            headers: authService.getAuthHeaders()
        });

        if (response.ok) {
            const result = await response.json();
            console.log('âœ… Notification status:', result.message);
            
            // Update local state immediately for better UX
            const notificationIndex = currentNotifications.findIndex(n => n._id === notificationId);
            if (notificationIndex !== -1) {
                currentNotifications[notificationIndex].is_read = true;
                displayNotifications(currentNotifications); // Update UI immediately
            }
            await updateUnreadCount(); // Refresh badge count
            
            // Only show notification if it was actually changed
            if (result.message.includes('marked as read')) {
                showNotification('Notification marked as read', 'success');
            }
        } else {
            const errorText = await response.text();
            console.error('âŒ Failed to mark notification as read:', response.status, errorText);
            
            let errorMessage = 'Failed to mark notification as read';
            try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.detail || errorMessage;
            } catch (e) {
                errorMessage = errorText || errorMessage;
            }
            
            showNotification(errorMessage, 'error');
        }
    } catch (error) {
        console.error('âŒ Network error marking notification as read:', error);
        showNotification('Network error: ' + error.message, 'error');
    }
}
async function markAllNotificationsAsRead() {
            try {
                const unreadNotifications = currentNotifications.filter(n => !n.is_read);
                
                for (const notification of unreadNotifications) {
                    await fetch(`${API_BASE_URL}/notifications/${notification._id}/read`, {
                        method: 'PUT',
                        headers: authService.getAuthHeaders()
                    });
                }
                
                showNotification('All notifications marked as read', 'success');
                await loadNotifications();
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showNotification('Error marking notifications as read', 'error');
            }
        }

        async function updateUnreadCount() {
            try {
                const response = await fetch(`${API_BASE_URL}/notifications/unread-count`, {
                    headers: authService.getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    unreadCount = data.unread_count;
                    const badge = document.getElementById('notificationBadge');
                    if (badge) {
                        badge.textContent = unreadCount;
                    }
                }
            } catch (error) {
                console.error('Error updating unread count:', error);
            }
        }

        function startNotificationPolling() {
            setInterval(async () => {
                await updateUnreadCount();
                
                // If there are new notifications and we're not on the notifications tab, show a toast
                if (unreadCount > 0) {
                    const notificationsTab = document.getElementById('notifications');
                    if (notificationsTab && !notificationsTab.classList.contains('active')) {
                        const previousCount = window.previousUnreadCount || 0;
                        if (unreadCount > previousCount) {
                            showNewNotificationToast(unreadCount);
                        }
                        window.previousUnreadCount = unreadCount;
                    }
                }
            }, 10000); // Check every 10 seconds
        }

        function showNewNotificationToast(count) {
            // Remove existing toast
            document.querySelectorAll('.new-notification-toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = 'new-notification-toast alert alert-info alert-dismissible fade show';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 1000;
                min-width: 300px;
            `;
            toast.innerHTML = `
                <i class="fas fa-bell me-2"></i>
                <strong>${count} new notification${count > 1 ? 's' : ''}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                <div class="mt-2">
                    <a href="#" onclick="switchToNotificationsTab()" class="btn btn-sm btn-primary">View</a>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }

        function switchToNotificationsTab() {
            // Switch to notifications tab
            const notificationsTab = document.querySelector('[href="#notifications"]');
            if (notificationsTab) {
                new bootstrap.Tab(notificationsTab).show();
            }
            
            // Remove the toast
            document.querySelectorAll('.new-notification-toast').forEach(toast => toast.remove());
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                z-index: 1000;
                min-width: 300px;
            `;
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>